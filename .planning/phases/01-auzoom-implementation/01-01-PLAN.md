---
phase: 01-auzoom-implementation
plan: 01
type: execute
---

<objective>
Complete the Tree-sitter parser foundation and CodeNode model for AuZoom, building on existing implementations in the auzoom/ folder.

Purpose: Establish the core parsing infrastructure that extracts Python code elements (functions, classes, methods, imports) with dependency resolution, enabling multi-resolution code navigation.

Output: Working parser that extracts CodeNodes from Python files with accurate line ranges, dependencies, and three serialization levels (skeleton/summary/full).
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

**Existing code**:
@auzoom/src/auzoom/models.py
@auzoom/pyproject.toml
@auzoom/README.md

**Tech stack available**: Tree-sitter 0.21+, tree-sitter-python 0.21+, Python 3.11+

**Constraining decisions**:
- Python-only for V1 (from PROJECT.md)
- Tree-sitter over ast module (multi-language path)
- Token targets: skeleton ~15, summary ~75, full ~400 tokens per node

**Prior specification**: AuZoom spec from Claude.ai conversation, referenced in auzoom/README.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Complete CodeNode model with serialization methods</name>
  <files>auzoom/src/auzoom/models.py</files>
  <action>
Enhance the existing CodeNode dataclass (already has NodeType, FetchLevel enums). Add these fields if missing:
- id: str (format: "file_path::qualified_name")
- name: str
- node_type: NodeType
- file_path: str
- line_start: int, line_end: int
- dependencies: list[str] (node IDs this depends on)
- children: list[str] (child node IDs)
- docstring: Optional[str]
- signature: Optional[str] (for functions/methods)
- source: Optional[str] (full source code)

Implement three serialization methods:
- to_skeleton() -> dict: Return {id, name, type, dependencies} (~15 tokens)
- to_summary() -> dict: skeleton + docstring (truncated to 100 chars) + signature (~75 tokens)
- to_full() -> dict: everything including full source (~400 tokens)

Include a helper: estimate_tokens(text: str) -> int that uses len(text) // 4 as rough estimate.
  </action>
  <verify>python -c "from auzoom.models import CodeNode, FetchLevel; n = CodeNode(id='test', name='foo', node_type='function', file_path='test.py', line_start=1, line_end=10, dependencies=[], children=[]); print(n.to_skeleton())"</verify>
  <done>CodeNode has complete fields and three working serialization methods</done>
</task>

<task type="auto">
  <name>Task 2: Implement Python parser with Tree-sitter</name>
  <files>auzoom/src/auzoom/parser.py</files>
  <action>
Create PythonParser class that uses tree-sitter-python:

```python
from tree_sitter import Language, Parser
import tree_sitter_python as tspython
from .models import CodeNode, NodeType

class PythonParser:
    def __init__(self):
        # Initialize tree-sitter with Python grammar
        PY_LANGUAGE = Language(tspython.language())
        self.parser = Parser(PY_LANGUAGE)

    def parse_file(self, file_path: str) -> list[CodeNode]:
        # Read file, parse with tree-sitter, extract all nodes
        with open(file_path, 'rb') as f:
            tree = self.parser.parse(f.read())

        nodes = []
        nodes.extend(self._extract_imports(tree, file_path))
        nodes.extend(self._extract_functions(tree, file_path))
        nodes.extend(self._extract_classes(tree, file_path))

        self._resolve_dependencies(nodes)
        return nodes

    def _extract_functions(self, tree, file_path) -> list[CodeNode]:
        # Tree-sitter query for function_definition nodes
        # Extract: name, parameters (signature), docstring, line range, source

    def _extract_classes(self, tree, file_path) -> list[CodeNode]:
        # Query for class_definition nodes
        # Extract methods as children, handle nested classes

    def _extract_imports(self, tree, file_path) -> list[CodeNode]:
        # Query for import_statement and import_from_statement

    def _resolve_dependencies(self, nodes: list[CodeNode]):
        # Analyze function/method bodies for function calls
        # Match calls to node names, populate dependencies field
```

Use tree-sitter's query syntax to extract nodes. Handle edge cases: decorators, nested classes, async functions. Avoid recursively parsing string literals or comments.
  </action>
  <verify>
# Create test file
echo 'def foo(): pass\nclass Bar:\n    def baz(self): pass' > /tmp/test_parser.py
python -c "from auzoom.parser import PythonParser; p = PythonParser(); nodes = p.parse_file('/tmp/test_parser.py'); print(f'Parsed {len(nodes)} nodes'); assert len(nodes) >= 2"
  </verify>
  <done>Parser extracts functions, classes, methods, and imports from Python files with accurate line ranges</done>
</task>

<task type="auto">
  <name>Task 3: Add basic integration test</name>
  <files>tests/test_parser.py</files>
  <action>
Create pytest test that validates parser with a realistic Python file:

```python
import pytest
from auzoom.parser import PythonParser
from auzoom.models import FetchLevel, NodeType

def test_parse_real_file():
    """Test parsing a file with mixed functions and classes."""
    # Create a test file with functions, class with methods, imports
    test_code = '''
import os
from typing import Optional

def helper(x: int) -> int:
    """Helper function."""
    return x * 2

class Calculator:
    """A calculator class."""

    def add(self, a: int, b: int) -> int:
        """Add two numbers."""
        return helper(a) + helper(b)

    def subtract(self, a: int, b: int) -> int:
        return a - b
'''

    with open('/tmp/test_calc.py', 'w') as f:
        f.write(test_code)

    parser = PythonParser()
    nodes = parser.parse_file('/tmp/test_calc.py')

    # Should find: 2 imports, 1 function, 1 class, 2 methods
    assert len(nodes) >= 5

    # Verify node types
    types = [n.node_type for n in nodes]
    assert NodeType.IMPORT in types
    assert NodeType.FUNCTION in types
    assert NodeType.CLASS in types
    assert NodeType.METHOD in types

    # Verify serialization
    for node in nodes:
        skeleton = node.to_skeleton()
        assert 'id' in skeleton
        assert 'name' in skeleton

        summary = node.to_summary()
        assert len(str(summary)) > len(str(skeleton))

        full = node.to_full()
        assert 'source' in full

def test_dependency_resolution():
    """Test that function calls are detected as dependencies."""
    test_code = '''
def caller():
    return callee()

def callee():
    return 42
'''
    with open('/tmp/test_deps.py', 'w') as f:
        f.write(test_code)

    parser = PythonParser()
    nodes = parser.parse_file('/tmp/test_deps.py')

    caller_node = [n for n in nodes if n.name == 'caller'][0]
    # Should have dependency on callee
    assert len(caller_node.dependencies) > 0
```

Run: pytest tests/test_parser.py -v
  </action>
  <verify>pytest tests/test_parser.py -v</verify>
  <done>Tests pass, demonstrating parser correctly extracts nodes and resolves dependencies</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] CodeNode model serializes to three levels with appropriate token counts
- [ ] Parser extracts all top-level definitions from test files
- [ ] Dependencies between functions are identified
- [ ] Tests pass without errors
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- Parse a Python file with 5+ nodes and produce correct node count, types, and line ranges
- skeleton output is significantly smaller than full output
</success_criteria>

<output>
After completion, create `.planning/phases/01-auzoom-implementation/01-01-SUMMARY.md`:

# Phase 1 Plan 01: Parser Foundation Summary

**[Substantive one-liner - what shipped]**

## Accomplishments

- CodeNode model with three-level serialization
- Tree-sitter Python parser extracting functions/classes/methods/imports
- Dependency resolution between code elements
- Integration tests proving core functionality

## Files Created/Modified

- `auzoom/src/auzoom/models.py` - Enhanced CodeNode with serialization
- `auzoom/src/auzoom/parser.py` - Tree-sitter parser implementation
- `tests/test_parser.py` - Integration tests

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Ready for 01-02-PLAN.md (Graph navigation & fetch levels)
</output>
