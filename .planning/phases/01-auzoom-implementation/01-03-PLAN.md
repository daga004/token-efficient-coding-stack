---
phase: 01-auzoom-implementation
plan: 03
type: execute
---

<objective>
Build the MCP (Model Context Protocol) server that exposes AuZoom as tools Claude Code can invoke for hierarchical code navigation.

Purpose: Enable Claude Code to navigate codebases efficiently via `auzoom_get_graph`, `auzoom_find`, and `auzoom_get_dependencies` tools, intercepting direct file reads for Python files.

Output: Running MCP server that responds to tool calls, with integration tests proving Claude Code can navigate code at multiple resolution levels.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-auzoom-implementation/01-01-SUMMARY.md
@.planning/phases/01-auzoom-implementation/01-02-SUMMARY.md

**Existing code**:
@auzoom/src/auzoom/models.py
@auzoom/src/auzoom/parser.py
@auzoom/src/auzoom/graph.py

**Tech stack available**: Complete parser and graph from 01-01 and 01-02

**Constraining decisions**:
- MCP as integration layer (PROJECT.md)
- Python-only file interception for V1
- Three tools: auzoom_get_graph, auzoom_find, auzoom_get_dependencies

**Research topics** (from ROADMAP): MCP server implementation patterns, file read interception
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement MCP server with tool handlers</name>
  <files>auzoom/src/auzoom/server.py</files>
  <action>
Implement MCP server using the Model Context Protocol specification. Reference: https://modelcontextprotocol.io/

```python
import json
from typing import Any
from .parser import PythonParser
from .graph import CodeGraph
from .models import FetchLevel

class AuZoomServer:
    """MCP server for AuZoom code navigation."""

    def __init__(self, project_root: str):
        self.project_root = project_root
        self.parser = PythonParser()
        self.graph = CodeGraph()
        self._index_project()

    def _index_project(self):
        """Index all Python files in project."""
        import os
        for root, dirs, files in os.walk(self.project_root):
            # Skip common ignore patterns
            dirs[:] = [d for d in dirs if d not in ['.git', '__pycache__', 'node_modules', '.venv']]

            for file in files:
                if file.endswith('.py'):
                    file_path = os.path.join(root, file)
                    try:
                        nodes = self.parser.parse_file(file_path)
                        for node in nodes:
                            self.graph.add_node(node)
                    except Exception as e:
                        print(f"Warning: Failed to parse {file_path}: {e}")

    def handle_tool_call(self, tool_name: str, arguments: dict[str, Any]) -> dict:
        """Dispatch tool calls to appropriate handlers."""
        if tool_name == "auzoom_get_graph":
            return self._tool_get_graph(arguments)
        elif tool_name == "auzoom_find":
            return self._tool_find(arguments)
        elif tool_name == "auzoom_get_dependencies":
            return self._tool_get_dependencies(arguments)
        else:
            return {"error": f"Unknown tool: {tool_name}"}

    def _tool_get_graph(self, args: dict) -> dict:
        """
        Get node graph at requested fetch level.

        Args:
            node_id (str): Node ID or file path
            fetch_level (str): "skeleton" | "summary" | "full"
            include_children (bool): Include child nodes
        """
        node_id = args.get("node_id")
        fetch_level_str = args.get("fetch_level", "skeleton")
        include_children = args.get("include_children", False)

        level = FetchLevel[fetch_level_str.upper()]

        # Check if node_id is a file path
        if node_id.endswith('.py'):
            return {
                "type": "file",
                "nodes": self.graph.get_file(node_id, level)
            }

        # Otherwise treat as node ID
        node_data = self.graph.get_node(node_id, level)

        if include_children:
            children = self.graph.get_children(node_id, level)
            node_data["children"] = children

        return {"type": "node", "data": node_data}

    def _tool_find(self, args: dict) -> dict:
        """
        Search for nodes by name pattern.

        Args:
            name_pattern (str): Substring to search for
        """
        pattern = args.get("name_pattern", "")
        matches = self.graph.find_by_name(pattern)
        return {"matches": matches}

    def _tool_get_dependencies(self, args: dict) -> dict:
        """
        Get dependency graph for a node.

        Args:
            node_id (str): Node to analyze
            depth (int): How many levels to traverse (default 1)
        """
        node_id = args.get("node_id")
        depth = args.get("depth", 1)

        deps = self.graph.get_dependencies(node_id, depth)
        return {"dependencies": deps}

    def run(self):
        """Run MCP server (stdio protocol)."""
        import sys

        for line in sys.stdin:
            try:
                request = json.loads(line)
                tool_name = request.get("tool")
                arguments = request.get("arguments", {})

                result = self.handle_tool_call(tool_name, arguments)

                response = {
                    "id": request.get("id"),
                    "result": result
                }
                print(json.dumps(response), flush=True)

            except Exception as e:
                error_response = {
                    "id": request.get("id"),
                    "error": str(e)
                }
                print(json.dumps(error_response), flush=True)
```

Keep stdio protocol simple for V1. Add proper MCP protocol headers if needed based on spec.
  </action>
  <verify>python -c "from auzoom.server import AuZoomServer; s = AuZoomServer('.'); print('Server initialized')"</verify>
  <done>MCP server initializes, indexes project, and handles tool calls</done>
</task>

<task type="auto">
  <name>Task 2: Create CLI entry point and configuration</name>
  <files>auzoom/src/auzoom/cli.py, auzoom/src/auzoom/__init__.py</files>
  <action>
Create CLI for starting the MCP server:

```python
# cli.py
import click
from .server import AuZoomServer

@click.group()
def main():
    """AuZoom CLI - Multi-resolution code navigation."""
    pass

@main.command()
@click.option('--project', default='.', help='Project root directory')
def serve(project):
    """Start AuZoom MCP server."""
    server = AuZoomServer(project)
    click.echo(f"AuZoom server started for project: {project}", err=True)
    server.run()

@main.command()
@click.argument('file_path')
def index(file_path):
    """Index a Python file and show stats."""
    from .parser import PythonParser
    from .graph import CodeGraph

    parser = PythonParser()
    graph = CodeGraph()

    nodes = parser.parse_file(file_path)
    for node in nodes:
        graph.add_node(node)

    stats = graph.get_token_stats(file_path)
    click.echo(f"File: {file_path}")
    click.echo(f"Nodes: {stats['nodes']}")
    click.echo(f"Tokens (skeleton): {stats['tokens_skeleton']}")
    click.echo(f"Tokens (full): {stats['tokens_full']}")
    click.echo(f"Reduction: {stats['reduction_ratio']:.1f}x")

if __name__ == '__main__':
    main()
```

Update __init__.py to export main classes:
```python
# __init__.py
from .models import CodeNode, FetchLevel, NodeType
from .parser import PythonParser
from .graph import CodeGraph
from .server import AuZoomServer

__version__ = "0.2.0"
__all__ = ["CodeNode", "FetchLevel", "NodeType", "PythonParser", "CodeGraph", "AuZoomServer"]
```

Verify pyproject.toml has entry point: `auzoom = "auzoom.cli:main"` (should already exist).
  </action>
  <verify>
cd auzoom && pip install -e . && auzoom index src/auzoom/models.py
  </verify>
  <done>CLI command works, shows token stats for indexed files</done>
</task>

<task type="auto">
  <name>Task 3: Create MCP server integration test</name>
  <files>tests/test_mcp_server.py</files>
  <action>
Test MCP server tool calls:

```python
import pytest
import json
from auzoom.server import AuZoomServer

def test_server_initialization():
    """Test server initializes and indexes project."""
    server = AuZoomServer('.')
    assert server.graph is not None
    assert len(server.graph.nodes) > 0  # Should have indexed some files

def test_get_graph_file():
    """Test auzoom_get_graph with file path."""
    server = AuZoomServer('.')

    result = server.handle_tool_call("auzoom_get_graph", {
        "node_id": "auzoom/src/auzoom/models.py",
        "fetch_level": "skeleton"
    })

    assert result["type"] == "file"
    assert "nodes" in result
    assert len(result["nodes"]) > 0

def test_get_graph_node():
    """Test auzoom_get_graph with node ID."""
    server = AuZoomServer('.')

    # Find a node first
    find_result = server.handle_tool_call("auzoom_find", {
        "name_pattern": "CodeNode"
    })

    if find_result["matches"]:
        node_id = find_result["matches"][0]["id"]

        # Get at different levels
        skeleton = server.handle_tool_call("auzoom_get_graph", {
            "node_id": node_id,
            "fetch_level": "skeleton"
        })

        summary = server.handle_tool_call("auzoom_get_graph", {
            "node_id": node_id,
            "fetch_level": "summary"
        })

        full = server.handle_tool_call("auzoom_get_graph", {
            "node_id": node_id,
            "fetch_level": "full"
        })

        # Verify progressive disclosure
        assert len(str(skeleton)) < len(str(summary)) < len(str(full))

def test_find_tool():
    """Test auzoom_find for searching."""
    server = AuZoomServer('.')

    result = server.handle_tool_call("auzoom_find", {
        "name_pattern": "parse"
    })

    assert "matches" in result
    # Should find parser-related functions

def test_get_dependencies():
    """Test auzoom_get_dependencies for context assembly."""
    server = AuZoomServer('.')

    # Find a function that has dependencies
    find_result = server.handle_tool_call("auzoom_find", {
        "name_pattern": "parse_file"
    })

    if find_result["matches"]:
        node_id = find_result["matches"][0]["id"]

        deps_result = server.handle_tool_call("auzoom_get_dependencies", {
            "node_id": node_id,
            "depth": 1
        })

        assert "dependencies" in deps_result
        # Dependencies list (may be empty for simple functions)

def test_unknown_tool():
    """Test error handling for unknown tools."""
    server = AuZoomServer('.')

    result = server.handle_tool_call("unknown_tool", {})

    assert "error" in result
```

Run: pytest tests/test_mcp_server.py -v
  </action>
  <verify>pytest tests/test_mcp_server.py -v</verify>
  <done>MCP server tests pass, all three tools working correctly</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] MCP server starts and responds to tool calls
- [ ] `auzoom_get_graph` returns data at all three fetch levels
- [ ] `auzoom_find` searches by name pattern
- [ ] `auzoom_get_dependencies` traverses dependency graph
- [ ] CLI command works: `auzoom serve --project .`
- [ ] All tests pass
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- MCP server responds correctly to all three tool types
- Integration tests demonstrate end-to-end functionality
- Phase 1 complete: AuZoom working end-to-end
</success_criteria>

<output>
After completion, create `.planning/phases/01-auzoom-implementation/01-03-SUMMARY.md`:

# Phase 1 Plan 03: MCP Server Summary

**[Substantive one-liner - what shipped]**

## Accomplishments

- MCP server exposing three navigation tools
- CLI for starting server and indexing files
- Full integration tests proving end-to-end workflow
- AuZoom V1 complete: parser + graph + MCP server working

## Files Created/Modified

- `auzoom/src/auzoom/server.py` - MCP server implementation
- `auzoom/src/auzoom/cli.py` - CLI entry point
- `auzoom/src/auzoom/__init__.py` - Package exports
- `tests/test_mcp_server.py` - Server integration tests

## Decisions Made

- Stdio protocol for MCP communication (simple for V1)
- Auto-index on server start (eager indexing)
- Skip unparseable files with warning (robustness)

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Phase Readiness

**Phase 1 Complete**: AuZoom MCP server ready for integration testing with Claude Code

Ready for Phase 2 (Orchestrator Implementation) or Phase 3 (Integration & Validation)
</output>
